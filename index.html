<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script type="text/javascript" src="hex_hmac_sha1.js"></script>
    <!--<script type="text/javascript" src="hex_md5.js"></script>-->
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <!-- <script src="https://dapenson.xyz/n/jq/jquery-3.3.1.min.js"></script> -->
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <!-- <script src="https://dapenson.xyz/n/particles.min.js"></script> -->
    <script src="https://cdn.bootcdn.net/ajax/libs/particlesjs/2.2.3/particles.min.js"></script>
    <link rel="stylesheet" href="aliyun_mqtt.css">
    <!-- <link rel="stylesheet" href="aliyun_mqtt.css"> -->
</head>

<body>
    <canvas class="background"></canvas>
    <div class="container">
        <h1>阿里云IOT接入</h1>

        <h3>你的阿里云物联网信息:</h3>
        <input class="tbx" type="text" id="productKey" name="productKey" placeholder="productKey"></input>
        <input class="tbx" type="text" id="deviceName" name="deviceName" placeholder="deviceName"></input>
        <input class="tbx" type="text" id="deviceSecret" name="deviceSecret" placeholder="deviceSecret"></input>
        <input class="tbx" type="text" id="clientId" name="clientId" placeholder="clientId(任意) "></input>

        <input type="text" id="timestamp" name="timestamp" style="visibility:hidden"></input>
        <!--method:默认使用hmacmd5 -->
        <select id="signMethod" name="signMethod" style="visibility:hidden">
            <!-- <option value="hmacmd5">hmacmd5</option> -->
            <option value="hmacsha1" selected>hmacsha1</option>
        </select>

        <button class="sub" id="onSign" name="onSign" onclick="onSign()"><b>一键生成接入信息</b></button>
        <br>

        <h3>MQTT接入信息:</h3>
        <input class="tbx" type="text" id="mqtt_url" name="mqtt_url" placeholder="URL"></input>
        <input class="tbx" type="text" id="mqtt_port" name="mqtt_port" placeholder="port"> </input>
        <input class="tbx" type="text" id="mqtt_clientid" name="mqtt_clientid" placeholder="clientID"></input>
        <input class="tbx" type="text" id="mqtt_name" name="mqtt_name" placeholder="Username"></input>
        <input class="tbx" type="text" id="password" name="password" placeholder="password"></input>

        <h3>HTTP接入信息:</h3>
        <textarea class="tbx" type="text" id="https_info" name="https_info" placeholder="设备认证"></textarea>

    </div>
</body>

<script>

    function onSign() {
        var pk = document.getElementById("productKey").value;
        var dn = document.getElementById("deviceName").value;
        var ds = document.getElementById("deviceSecret").value;
        var ts = document.getElementById("timestamp").value;
        var ci = document.getElementById("clientId").value;
        var sm = document.getElementById("signMethod").value;
        var pw = document.getElementById("password");

        var url = document.getElementById("mqtt_url");
        var port = document.getElementById("mqtt_port");
        var id = document.getElementById("mqtt_clientid");
        var name = document.getElementById("mqtt_name");

        var hp = document.getElementById("https_info");

        if (pk == null || pk == "" || dn == null || dn == ""
            || ds == null || ds == "" || ci == null || ci == "") {
            alert("productKey,deviceName,deviceSecret,clientId 不能为空");
            return;
        }
        var options = {
            productKey: pk,
            deviceName: dn,
            timestamp: ts,
            clientId: ci
        }
        if (ts == null || ts == "") {
            options = {
                productKey: pk,
                deviceName: dn,
                clientId: ci
            }
        }
        var keys = Object.keys(options).sort();
        // 按字典序排序
        keys = keys.sort();
        var list = [];
        keys.forEach(function (key) {
            list.push(key + options[key]);
        });
        var contentStr = list.join('');
        var sign = "";
        if (sm == "hmacmd5") {
            sign = hex_hmac_md5(ds, contentStr);
        } else if (sm == "hmacsha1") {
            sign = hex_hmac_sha1(ds, contentStr);
        } else {
            alert("method is invalid");
        }
        pw.value = sign.toUpperCase();
        url.value = mix('${YourProductKey}.iot-as-mqtt.cn-shanghai.aliyuncs.com', { YourProductKey: pk });
        port.value = mix('${port}', { port: 1883 });
        id.value = mix('${clientID}|securemode=3,signmethod=hmacsha1|', { clientID: ci });
        name.value = mix('${YourDeviceName}&${YourProductKey}', { YourDeviceName: dn, YourProductKey: pk });

        hp.value = mix('"{\\"clientId\\":\\"${clientID}\\",\\"signmethod\\":\\"hmacsha1\\",\\"sign\\":\\"${sign}\\",\\"productKey\\":\\"${YourProductKey}\\",\\"deviceName\\":\\"${YourDeviceName}\\"}"', { clientID: ci, sign: pw.value, YourProductKey: pk, YourDeviceName: dn });
    }
    function mix(str, group) {
        var reg = /\$\{[^{}]+\}/gm;
        var strArr = str.split(reg);
        var labelArr = str.match(reg);
        var returnString = '',
            i = 0,
            label, len = labelArr.length;
        for (; i < len; i++) {
            label = labelArr[i].slice(2, -1);
            returnString += strArr[i] + (group[label] != null ? group[label] : '');
        }
        return returnString + strArr[i];
    }

    document.onkeydown = function (e) { // 回车提交表单
        // 兼容FF和IE和Opera
        var theEvent = window.event || e;
        var code = theEvent.keyCode || theEvent.which || theEvent.charCode;
        if (code == 13) {
            onSign();
        }
    }


    Particles.init({

        // normal options
        selector: '.background',
        maxParticles: 80,
        color: ['#6dedff'],
        connectParticles: 1,
        minDistance: 100,


        // options for breakpoints
        responsive: [
            {
                breakpoint:
                    768
                ,
                options: {
                    maxParticles:
                        200
                    ,
                    color:
                        '#48F2E3'
                    ,
                    connectParticles:
                        true
                }
            }, {
                breakpoint:
                    425
                ,
                options: {
                    maxParticles:
                        100
                    ,
                    connectParticles:
                        true
                }
            }, {
                breakpoint:
                    320
                ,
                options: {
                    maxParticles:
                        0

                    // disables particles.js
                }
            }
        ]
    });
</script>

</html>